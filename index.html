<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kanban Board (Auth + Admin + Sync + Import/Export)</title>
  <style>
    :root{
      --bg:#0b1220;
      --border:#223055;
      --text:#e7ecff;
      --muted:#aab3d6;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --gap:14px;
      --cardBorder:#2a3b67;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, #13224b 0%, transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, #1c2a5f 0%, transparent 60%),
                  var(--bg);
      color:var(--text);
      min-height:100vh;
      padding:24px;
    }

    header{
      max-width:1200px;
      margin:0 auto 14px auto;
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      justify-content:space-between;
    }
    .title{ display:flex; flex-direction:column; gap:4px; }
    h1{ margin:0; font-size:20px; letter-spacing:.2px; }
    .subtitle{ margin:0; color:var(--muted); font-size:13px; }

    .addbar{
      display:flex;
      gap:10px;
      align-items:center;
      background:rgba(255,255,255,.03);
      border:1px solid var(--border);
      padding:10px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      flex-wrap:wrap;
    }
    input, select, button{
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      outline:none;
      font-size:14px;
    }
    input::placeholder{ color:#7f89b3; }
    button{
      cursor:pointer;
      border-color:#2c4278;
      background: linear-gradient(180deg, rgba(106,169,255,.18), rgba(106,169,255,.06));
    }
    button:hover{ border-color:#3e63b7; }
    button.danger{
      border-color:rgba(255,106,106,.45);
      background:rgba(255,106,106,.08);
    }

    .wrap{ max-width:1200px; margin:0 auto; }
    .board{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--gap);
    }
    @media (max-width: 1100px){ .board{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 640px){
      .board{ grid-template-columns: 1fr; }
      body{ padding:16px; }
      .addbar{ width:100%; }
      input{ min-width: 170px; }
    }

    .column{
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 420px;
    }
    .colhead{
      padding:14px 14px 10px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .colname{ display:flex; align-items:center; gap:10px; font-weight:600; font-size:14px; }
    .badge{
      font-size:12px;
      color:var(--muted);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      padding:2px 8px;
      border-radius:999px;
    }

    .dropzone{
      padding: 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1;
    }
    .column.dragover{
      outline:2px dashed rgba(106,169,255,.55);
      outline-offset:-8px;
      background: rgba(106,169,255,.06);
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--cardBorder);
      border-radius: 14px;
      padding: 12px;
      cursor: grab;
      user-select:none;
    }
    .card:active{ cursor: grabbing; }
    .cardtitle{
      margin:0 0 6px 0;
      font-size:14px;
      font-weight:600;
      line-height:1.25;
      word-break: break-word;
    }
    .meta{
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      color:var(--muted);
      font-size:12px;
    }
    .pill{
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.1);
      background: rgba(0,0,0,.12);
    }
    .actions{ display:flex; gap:6px; align-items:center; }
    .iconbtn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding:4px 8px;
      border-radius:10px;
      font-size:12px;
      cursor:pointer;
    }
    .iconbtn:hover{ border-color: rgba(106,169,255,.55); }
    .iconbtn.delete:hover{ border-color: rgba(255,106,106,.6); }

    .statusbar{
      max-width:1200px;
      margin:0 auto 12px auto;
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    code{ color:#cfe1ff; }

    .disabled{
      opacity:.55;
      pointer-events:none;
      filter: grayscale(.2);
    }
    .small{
      font-size:12px;
      color:var(--muted);
    }

    /* Admin panel */
    .panel{
      margin-top:14px;
      padding:12px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
    }
    .panel h2{
      margin:0 0 8px 0;
      font-size:14px;
    }
    .userbox{
      margin:10px 0;
      padding:10px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
    }
    .boardbox{
      margin:8px 0;
      padding:8px;
      border:1px dashed rgba(255,255,255,.12);
      border-radius:12px;
    }
    .muted{ color:var(--muted); }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <h1>Kanban Board</h1>
      <p class="subtitle">Email/Password login + per-user boards + Admin View All + Import/Export JSON</p>
    </div>

    <div class="addbar">
      <!-- AUTH -->
      <input id="email" type="email" placeholder="Email" style="min-width:220px;" />
      <input id="password" type="password" placeholder="Password" style="min-width:200px;" />
      <button id="signupBtn">Sign up</button>
      <button id="signinBtn">Sign in</button>
      <button id="logoutBtn" class="danger" style="display:none;">Logout</button>

      <span id="userLabel" class="small"></span>
      <span id="uidLabel" class="small"></span>

      <span style="width:14px;"></span>

      <!-- TASK INPUT -->
      <input id="taskInput" type="text" placeholder="New task (e.g., Fix login bug)" />
      <select id="statusSelect">
        <option value="todo">To Do</option>
        <option value="inprogress">In Progress</option>
        <option value="review">Review</option>
        <option value="done">Done</option>
      </select>
      <button id="addBtn">Add</button>
      <button id="clearBtn" class="danger" title="Remove all tasks">Clear</button>

      <!-- IMPORT/EXPORT -->
      <button id="exportBtn" title="Download tasks as JSON">Export JSON</button>
      <button id="importBtn" title="Load tasks from JSON (replaces current board)">Import JSON</button>
      <input id="importFile" type="file" accept="application/json" style="display:none" />

      <!-- ADMIN -->
      <button id="adminViewBtn" style="display:none;">Admin: View All</button>
      <button id="myViewBtn" style="display:none;">My Board</button>
    </div>
  </header>

  <div class="statusbar">
    <div>Board: <code id="boardIdLabel"></code></div>
    <div id="syncLabel">Sync: signed out</div>
  </div>

  <div class="wrap">
    <div class="board disabled" id="board">
      <div class="column" data-status="todo">
        <div class="colhead">
          <div class="colname">To Do <span class="badge" id="count-todo">0</span></div>
        </div>
        <div class="dropzone" id="zone-todo"></div>
      </div>

      <div class="column" data-status="inprogress">
        <div class="colhead">
          <div class="colname">In Progress <span class="badge" id="count-inprogress">0</span></div>
        </div>
        <div class="dropzone" id="zone-inprogress"></div>
      </div>

      <div class="column" data-status="review">
        <div class="colhead">
          <div class="colname">Review <span class="badge" id="count-review">0</span></div>
        </div>
        <div class="dropzone" id="zone-review"></div>
      </div>

      <div class="column" data-status="done">
        <div class="colhead">
          <div class="colname">Done <span class="badge" id="count-done">0</span></div>
        </div>
        <div class="dropzone" id="zone-done"></div>
      </div>
    </div>

    <!-- Admin panel -->
    <div id="adminPanel" class="panel" style="display:none;"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";

    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    import {
      getFirestore,
      doc,
      onSnapshot,
      setDoc,
      getDoc,
      collectionGroup,
      getDocs,
      query
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // =========================
    // ðŸ” PASTE YOUR firebaseConfig HERE
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyC-OqHdrsG2L-blbs-R9OSf19qf-XHYiFo",
      authDomain: "kanban-29350.firebaseapp.com",
      projectId: "kanban-29350",
      storageBucket: "kanban-29350.firebasestorage.app",
      messagingSenderId: "696423970590",
      appId: "1:696423970590:web:ea0a5d4f6dee6266ea7b0f",
      measurementId: "G-QK2JE3CEDF"
    };

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Board id from URL
    const params = new URLSearchParams(location.search);
    const boardId = (params.get("board") || "default").trim();
    document.getElementById("boardIdLabel").textContent = boardId;

    // UI refs
    const $ = (sel) => document.querySelector(sel);

    const boardEl = $("#board");
    const adminPanel = $("#adminPanel");
    const syncLabel = $("#syncLabel");
    const setSync = (txt) => (syncLabel.textContent = "Sync: " + txt);

    const emailEl = $("#email");
    const passEl = $("#password");
    const signupBtn = $("#signupBtn");
    const signinBtn = $("#signinBtn");
    const logoutBtn = $("#logoutBtn");
    const userLabel = $("#userLabel");
    const uidLabel = $("#uidLabel");

    const taskInput = $("#taskInput");
    const statusSelect = $("#statusSelect");
    const addBtn = $("#addBtn");
    const clearBtn = $("#clearBtn");

    const exportBtn = $("#exportBtn");
    const importBtn = $("#importBtn");
    const importFile = $("#importFile");

    const adminViewBtn = $("#adminViewBtn");
    const myViewBtn = $("#myViewBtn");

    const zones = {
      todo: $("#zone-todo"),
      inprogress: $("#zone-inprogress"),
      review: $("#zone-review"),
      done: $("#zone-done"),
    };

    /** @type {{id:string,title:string,status:'todo'|'inprogress'|'review'|'done',createdAt:number}[]} */
    let tasks = [];

    let currentUser = null;
    let unsubscribeBoard = null;
    let isAdmin = false;

    // Helpers
    function uid() {
      return (crypto?.randomUUID?.() ?? ("id-" + Math.random().toString(16).slice(2))) + "-" + Date.now();
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function formatDate(ts) {
      const d = new Date(ts);
      return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "2-digit" });
    }

    function updateCounts() {
      const counts = { todo: 0, inprogress: 0, review: 0, done: 0 };
      for (const t of tasks) counts[t.status]++;

      $("#count-todo").textContent = counts.todo;
      $("#count-inprogress").textContent = counts.inprogress;
      $("#count-review").textContent = counts.review;
      $("#count-done").textContent = counts.done;
    }

    function clearZones() {
      Object.values(zones).forEach(z => z.innerHTML = "");
    }

    function normalizeImportedTasks(arr) {
      const allowed = new Set(["todo", "inprogress", "review", "done"]);
      const out = [];
      for (const item of arr) {
        if (!item || typeof item !== "object") continue;
        const title = String(item.title ?? "").trim();
        const status = String(item.status ?? "todo");
        const createdAt = Number(item.createdAt ?? Date.now());
        const id = String(item.id ?? uid());
        if (!title) continue;
        out.push({
          id,
          title,
          status: allowed.has(status) ? status : "todo",
          createdAt: Number.isFinite(createdAt) ? createdAt : Date.now()
        });
      }
      out.sort((a,b) => a.createdAt - b.createdAt);
      return out;
    }

    function createCard(task) {
      const card = document.createElement("div");
      card.className = "card";
      card.draggable = true;
      card.dataset.id = task.id;

      card.innerHTML = `
        <p class="cardtitle"></p>
        <div class="meta">
          <span class="pill">${task.status}</span>
          <div class="actions">
            <button class="iconbtn" data-action="edit" title="Edit">Edit</button>
            <button class="iconbtn delete" data-action="delete" title="Delete">Delete</button>
          </div>
        </div>
        <div class="meta" style="margin-top:8px;">
          <span>Created: ${formatDate(task.createdAt)}</span>
          <span class="pill">Drag me</span>
        </div>
      `;

      card.querySelector(".cardtitle").textContent = task.title;

      card.addEventListener("click", async (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;

        const action = btn.dataset.action;

        if (action === "delete") {
          tasks = tasks.filter(t => t.id !== task.id);
          await saveCloud();
          render();
        } else if (action === "edit") {
          const next = prompt("Edit task title:", task.title);
          if (next && next.trim()) {
            const t = tasks.find(t => t.id === task.id);
            if (!t) return;
            t.title = next.trim();
            await saveCloud();
            render();
          }
        }
      });

      card.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("text/plain", task.id);
        e.dataTransfer.effectAllowed = "move";
        card.style.opacity = "0.6";
      });

      card.addEventListener("dragend", () => {
        card.style.opacity = "1";
      });

      return card;
    }

    function render() {
      clearZones();

      const byCol = { todo: [], inprogress: [], review: [], done: [] };
      for (const t of tasks) byCol[t.status]?.push(t);

      for (const k of Object.keys(byCol)) {
        byCol[k].sort((a,b) => a.createdAt - b.createdAt);
        for (const t of byCol[k]) zones[k].appendChild(createCard(t));
      }

      updateCounts();
    }

    function boardDocRefForUser(userUid) {
      return doc(db, "users", userUid, "boards", boardId);
    }

    function boardDocRef() {
      return boardDocRefForUser(currentUser.uid);
    }

    async function ensureBoardDocExists() {
      const ref = boardDocRef();
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, { tasks: [], createdAt: Date.now() });
      }
    }

    async function saveCloud() {
      if (!currentUser) return;
      setSync("savingâ€¦");
      await setDoc(boardDocRef(), { tasks, updatedAt: Date.now() }, { merge: true });
      setSync("saved");
    }

    // TASK add/clear
    async function addTask() {
      if (!currentUser) return;
      const title = taskInput.value.trim();
      const status = statusSelect.value;
      if (!title) return;

      tasks.push({ id: uid(), title, status, createdAt: Date.now() });
      taskInput.value = "";
      await saveCloud();
      render();
      taskInput.focus();
    }

    addBtn.addEventListener("click", addTask);
    taskInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addTask();
    });

    clearBtn.addEventListener("click", async () => {
      if (!currentUser) return;
      if (!confirm("Clear all tasks on this board?")) return;
      tasks = [];
      await saveCloud();
      render();
    });

    // Drag & drop
    document.querySelectorAll(".column").forEach(col => {
      const status = col.dataset.status;

      col.addEventListener("dragover", (e) => {
        if (!currentUser) return;
        e.preventDefault();
        col.classList.add("dragover");
        e.dataTransfer.dropEffect = "move";
      });

      col.addEventListener("dragleave", () => col.classList.remove("dragover"));

      col.addEventListener("drop", async (e) => {
        if (!currentUser) return;
        e.preventDefault();
        col.classList.remove("dragover");

        const id = e.dataTransfer.getData("text/plain");
        const t = tasks.find(x => x.id === id);
        if (!t) return;

        t.status = status;
        await saveCloud();
        render();
      });
    });

    // Export JSON (current user's board)
    exportBtn.addEventListener("click", () => {
      if (!currentUser) return;
      const payload = {
        boardId,
        exportedAt: new Date().toISOString(),
        userUid: currentUser.uid,
        tasks
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `kanban-${boardId}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // Import JSON (replaces current user's board)
    importBtn.addEventListener("click", () => {
      if (!currentUser) return;
      importFile.click();
    });

    importFile.addEventListener("change", async () => {
      if (!currentUser) return;
      const file = importFile.files?.[0];
      if (!file) return;

      try {
        const text = await file.text();
        const parsed = JSON.parse(text);

        const incoming = Array.isArray(parsed) ? parsed : parsed?.tasks;
        if (!Array.isArray(incoming)) throw new Error("Invalid JSON format. Expected an array or {tasks:[]}");

        const normalized = normalizeImportedTasks(incoming);

        if (!confirm(`Import ${normalized.length} tasks? This will REPLACE your board "${boardId}".`)) {
          importFile.value = "";
          return;
        }

        tasks = normalized;
        await saveCloud();
        render();
      } catch (e) {
        console.error(e);
        alert(e.message || "Invalid JSON file.");
      } finally {
        importFile.value = "";
      }
    });

    // =========================
    // ADMIN
    // =========================
    async function checkAdmin(uid) {
      try {
        const snap = await getDoc(doc(db, "admins", uid));
        return snap.exists();
      } catch (e) {
        console.error("Admin check blocked by rules:", e);
        return false;
      }
    }

    async function loadAllBoardsForAdmin() {
      if (!currentUser || !isAdmin) return;

      setSync("admin loadingâ€¦");
      adminPanel.style.display = "";
      adminPanel.innerHTML = `<h2>Admin View</h2><div class="muted">Loading all users' boardsâ€¦</div>`;

      // Reads ALL docs in users/*/boards/*
      const q = query(collectionGroup(db, "boards"));
      const snap = await getDocs(q);

      // Group by userId
      const grouped = new Map(); // userId -> [{boardId, tasks}]
      snap.forEach(docSnap => {
        const path = docSnap.ref.path; // "users/{uid}/boards/{boardId}"
        const parts = path.split("/");
        const userId = parts[1];
        const bId = parts[3];
        const data = docSnap.data();
        const t = Array.isArray(data?.tasks) ? data.tasks : [];

        if (!grouped.has(userId)) grouped.set(userId, []);
        grouped.get(userId).push({ boardId: bId, tasks: t });
      });

      let html = `<h2>Admin View (read-only)</h2>
        <div class="muted">Users: ${grouped.size} â€¢ Board docs: ${snap.size}</div>`;

      for (const [userId, boards] of grouped.entries()) {
        html += `<div class="userbox">
          <div style="font-weight:600;margin-bottom:6px;">User UID: <code>${escapeHtml(userId)}</code></div>`;

        // Sort boards by name for nicer view
        boards.sort((a,b) => a.boardId.localeCompare(b.boardId));

        for (const b of boards) {
          html += `<div class="boardbox">
            <div class="muted">Board: <code>${escapeHtml(b.boardId)}</code> â€¢ Tasks: ${b.tasks.length}</div>
            <ul style="margin:8px 0 0 0;padding-left:18px;">`;

          // Sort tasks by createdAt
          const list = [...b.tasks].sort((x,y) => (x.createdAt||0) - (y.createdAt||0));
          for (const t of list) {
            html += `<li><span class="pill">${escapeHtml(t.status)}</span> ${escapeHtml(t.title)}</li>`;
          }
          html += `</ul></div>`;
        }

        html += `</div>`;
      }

      adminPanel.innerHTML = html;
      setSync("admin view");
    }

    adminViewBtn.addEventListener("click", async () => {
      if (!isAdmin) return;
      // Hide normal board while in admin view
      boardEl.style.display = "none";
      adminPanel.style.display = "";
      myViewBtn.style.display = "";
      await loadAllBoardsForAdmin();
    });

    myViewBtn.addEventListener("click", () => {
      adminPanel.style.display = "none";
      boardEl.style.display = "";
      myViewBtn.style.display = "none";
      setSync(currentUser ? "live" : "signed out");
    });

    // =========================
    // AUTH actions
    // =========================
    signupBtn.addEventListener("click", async () => {
      try {
        setSync("signing upâ€¦");
        await createUserWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
      } catch (e) {
        console.error(e);
        setSync("error");
        alert(e?.message || "Signup failed");
      }
    });

    signinBtn.addEventListener("click", async () => {
      try {
        setSync("signing inâ€¦");
        await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
      } catch (e) {
        console.error(e);
        setSync("error");
        alert(e?.message || "Signin failed");
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // Auth state -> connect to board
    onAuthStateChanged(auth, async (user) => {
      // cleanup old snapshot listener
      if (unsubscribeBoard) { unsubscribeBoard(); unsubscribeBoard = null; }

      currentUser = user;
      isAdmin = false;

      // reset admin UI
      adminPanel.style.display = "none";
      myViewBtn.style.display = "none";
      boardEl.style.display = "";

      if (!user) {
        tasks = [];
        render();
        boardEl.classList.add("disabled");
        logoutBtn.style.display = "none";
        userLabel.textContent = "";
        uidLabel.textContent = "";
        adminViewBtn.style.display = "none";
        setSync("signed out");
        return;
      }

      // signed in
      boardEl.classList.remove("disabled");
      logoutBtn.style.display = "";
      userLabel.textContent = user.email || "Signed in";
      uidLabel.textContent = `UID: ${user.uid}`;

      isAdmin = await checkAdmin(user.uid);
      adminViewBtn.style.display = isAdmin ? "" : "none";

      await ensureBoardDocExists();

      setSync("connectingâ€¦");
      unsubscribeBoard = onSnapshot(boardDocRef(), (snap) => {
        const data = snap.data();
        tasks = Array.isArray(data?.tasks) ? data.tasks : [];
        render();
        setSync("live");
      }, (err) => {
        console.error(err);
        setSync("permission error (check rules)");
      });
    });

    // Initial render
    render();
  </script>
</body>
</html>
