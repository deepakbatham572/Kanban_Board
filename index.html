<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kanban Board</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f1730; --panel2:rgba(255,255,255,.03);
      --border:#223055; --text:#e7ecff; --muted:#aab3d6;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px; --gap:14px; --cardBorder:#2a3b67;
      --accent: rgba(106,169,255,.55); --danger: rgba(255,106,106,.6);

      --inputBg: rgba(255,255,255,.03);
      --inputBorder: var(--border);
      --selectBg: rgba(255,255,255,.03);
      --selectText: var(--text);

      /* dropdown option visibility */
      --selectOptionBg: #ffffff;
      --selectOptionText: #111827;
    }
    html[data-theme="light"]{
      --bg:#f4f6fb; --panel:#ffffff; --panel2: rgba(0,0,0,.03);
      --border:#d8def0; --text:#0e1530; --muted:#4b587a;
      --shadow: 0 10px 30px rgba(15,23,48,.10);
      --cardBorder:#cdd6ef; --accent: rgba(37,99,235,.45); --danger: rgba(220,38,38,.55);

      --inputBg: rgba(255,255,255,.92);
      --inputBorder: #cdd6ef;
      --selectBg: rgba(255,255,255,.95);
      --selectText: #0e1530;

      --selectOptionBg: #ffffff;
      --selectOptionText: #111827;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(19,34,75,.60) 0%, transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(28,42,95,.55) 0%, transparent 60%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      padding:22px;
    }
    html[data-theme="light"] body{
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(214,230,255,.70) 0%, transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(226,232,255,.65) 0%, transparent 60%),
        var(--bg);
    }

    .topbar{
      max-width:1200px;
      margin:0 auto 14px auto;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .title{ display:flex; flex-direction:column; gap:4px; }
    h1{ margin:0; font-size:20px; letter-spacing:.2px; }
    .subtitle{ margin:0; color:var(--muted); font-size:13px; }

    /* profile dropdown */
    .profileWrap{ position:relative; display:flex; align-items:center; justify-content:flex-end; min-width: 240px; }
    .pillBtn{
      display:flex; align-items:center; gap:10px;
      border-radius:999px; border:1px solid var(--border);
      background: var(--panel2);
      color:var(--text);
      padding:8px 10px;
      cursor:pointer;
      box-shadow: var(--shadow);
      user-select:none;
    }
    .pillBtn:hover{ border-color: rgba(106,169,255,.45); }
    html[data-theme="light"] .pillBtn:hover{ border-color: rgba(37,99,235,.35); }

    .avatar{
      width:30px; height:30px; border-radius:50%;
      display:grid; place-items:center;
      background: linear-gradient(180deg, rgba(106,169,255,.25), rgba(106,169,255,.08));
      border:1px solid rgba(255,255,255,.12);
      font-weight:700; font-size:13px;
    }
    html[data-theme="light"] .avatar{ border:1px solid rgba(0,0,0,.08); }

    .who{ display:flex; flex-direction:column; line-height:1.1; max-width: 170px; }
    .who .name{ font-size:13px; font-weight:650; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .who .hint{ font-size:11px; color:var(--muted); }
    .caret{
      width:0;height:0;
      border-left:5px solid transparent;
      border-right:5px solid transparent;
      border-top:6px solid var(--muted);
      margin-left:2px;
    }

    .menu{
      position:absolute;
      top: 44px;
      right: 0;
      width: 360px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(12,18,38,.92);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
      display:none;
      z-index: 1000;
    }
    html[data-theme="light"] .menu{
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.92);
    }
    .menu.open{ display:block; }

    .menuHead{
      padding:12px 12px 10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    html[data-theme="light"] .menuHead{ border-bottom:1px solid rgba(0,0,0,.08); }

    .tag{
      font-size:11px; color: var(--muted);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding:2px 8px; border-radius: 999px;
    }
    html[data-theme="light"] .tag{
      border:1px solid rgba(0,0,0,.12);
      background: rgba(0,0,0,.03);
    }
    .tag.admin{
      border-color: rgba(106,169,255,.45);
      background: rgba(106,169,255,.10);
      color: #cfe1ff;
    }
    html[data-theme="light"] .tag.admin{
      color:#0b2a6b;
      background: rgba(37,99,235,.10);
      border-color: rgba(37,99,235,.25);
    }

    .menuBody{ padding:12px; display:flex; flex-direction:column; gap:10px; }

    .tabs{ display:flex; gap:8px; }
    .tab{
      flex:1;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      text-align:center;
      font-size:13px;
      color: var(--muted);
    }
    html[data-theme="light"] .tab{
      border:1px solid rgba(0,0,0,.10);
      background: rgba(0,0,0,.02);
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(106,169,255,.35);
      background: rgba(106,169,255,.08);
    }
    html[data-theme="light"] .tab.active{
      border-color: rgba(37,99,235,.25);
      background: rgba(37,99,235,.08);
    }

    .row{ display:flex; gap:10px; }
    .row > *{ flex:1; }

    input, select, button{
      border-radius:12px;
      border:1px solid var(--inputBorder);
      background: var(--inputBg);
      color:var(--text);
      padding:10px 12px;
      outline:none;
      font-size:14px;
    }
    input::placeholder{ color:#7f89b3; }
    html[data-theme="light"] input::placeholder{ color:#6b7aa7; }

    /* SELECT VISIBILITY FIX */
    select{ background: var(--selectBg); color: var(--selectText); }
    select option{ background: var(--selectOptionBg); color: var(--selectOptionText); }

    button{
      cursor:pointer;
      border-color:#2c4278;
      background: linear-gradient(180deg, rgba(106,169,255,.18), rgba(106,169,255,.06));
    }
    html[data-theme="light"] button{
      border-color: rgba(37,99,235,.35);
      background: linear-gradient(180deg, rgba(37,99,235,.12), rgba(37,99,235,.06));
    }
    button:hover{ border-color:#3e63b7; }
    html[data-theme="light"] button:hover{ border-color: rgba(37,99,235,.55); }

    button.danger{
      border-color: rgba(255,106,106,.45);
      background: rgba(255,106,106,.08);
    }
    html[data-theme="light"] button.danger{
      border-color: rgba(220,38,38,.35);
      background: rgba(220,38,38,.08);
    }

    .fineprint{ color:var(--muted); font-size:12px; }
    code{ color:#cfe1ff; }
    html[data-theme="light"] code{ color:#1f3a8a; }

    /* controls */
    .controls{
      max-width:1200px;
      margin: 0 auto 12px auto;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      background: var(--panel2);
      border: 1px solid var(--border);
      padding:10px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .controls .spacer{ flex:1; min-width: 12px; }

    /* NEW TASK EXPAND */
    #taskInput{
      flex: 2.2;
      min-width: 320px;
    }
    #statusSelect{ min-width: 160px; }

    .statusbar{
      max-width:1200px;
      margin:0 auto 12px auto;
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .wrap{ max-width:1200px; margin:0 auto; }

    .board{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--gap);
    }
    @media (max-width: 1100px){ .board{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 640px){
      .board{ grid-template-columns: 1fr; }
      body{ padding:16px; }
      #taskInput{ min-width: 100%; flex: 1 1 100%; }
    }

    .column{
      background: rgba(255,255,255,.03);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 420px;
    }
    html[data-theme="light"] .column{ background: rgba(255,255,255,.65); }

    .colhead{
      padding:14px 14px 10px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    html[data-theme="light"] .colhead{ border-bottom:1px solid rgba(0,0,0,.06); }

    .colname{ display:flex; align-items:center; gap:10px; font-weight:600; font-size:14px; }
    .badge{
      font-size:12px;
      color:var(--muted);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      padding:2px 8px;
      border-radius:999px;
    }
    html[data-theme="light"] .badge{
      background: rgba(0,0,0,.03);
      border:1px solid rgba(0,0,0,.08);
    }

    .dropzone{ padding: 12px; display:flex; flex-direction:column; gap:10px; flex:1; }
    .column.dragover{
      outline:2px dashed var(--accent);
      outline-offset:-8px;
      background: rgba(106,169,255,.06);
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--cardBorder);
      border-radius: 14px;
      padding: 12px;
      cursor: grab;
      user-select:none;
    }
    html[data-theme="light"] .card{
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.75));
    }
    .card:active{ cursor: grabbing; }
    .cardtitle{ margin:0 0 6px 0; font-size:14px; font-weight:600; line-height:1.25; word-break: break-word; }
    .meta{ display:flex; gap:8px; align-items:center; justify-content:space-between; color:var(--muted); font-size:12px; }
    .pill{
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.1);
      background: rgba(0,0,0,.12);
    }
    html[data-theme="light"] .pill{
      border:1px solid rgba(0,0,0,.08);
      background: rgba(0,0,0,.03);
    }
    .actions{ display:flex; gap:6px; align-items:center; }
    .iconbtn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding:4px 8px;
      border-radius:10px;
      font-size:12px;
      cursor:pointer;
    }
    html[data-theme="light"] .iconbtn{
      border:1px solid rgba(0,0,0,.10);
      background: rgba(0,0,0,.03);
    }
    .iconbtn:hover{ border-color: rgba(106,169,255,.55); }
    .iconbtn.delete:hover{ border-color: var(--danger); }

    .disabled{ opacity:.55; pointer-events:none; filter: grayscale(.2); }

    .panel{
      margin-top:14px;
      padding:12px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: rgba(255,255,255,.03);
      box-shadow: var(--shadow);
      display:none;
    }
    html[data-theme="light"] .panel{ background: rgba(255,255,255,.75); }
    .panel.open{ display:block; }
    .panel h2{ margin:0 0 8px 0; font-size:14px; }
    .userbox{ margin:10px 0; padding:10px; border:1px solid rgba(255,255,255,.08); border-radius:12px; }
    html[data-theme="light"] .userbox{ border:1px solid rgba(0,0,0,.08); }
    .boardbox{ margin:8px 0; padding:8px; border:1px dashed rgba(255,255,255,.12); border-radius:12px; }
    html[data-theme="light"] .boardbox{ border:1px dashed rgba(0,0,0,.12); }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="title">
      <h1>Kanban Board</h1>
      <p class="subtitle">Drag & drop tasks. Sync across devices. Theme toggle in profile.</p>
    </div>

    <div class="profileWrap">
      <div id="profileBtn" class="pillBtn" aria-label="Profile menu">
        <div class="avatar" id="avatar">?</div>
        <div class="who">
          <div class="name" id="whoName">Guest</div>
          <div class="hint" id="whoHint">Sign in</div>
        </div>
        <div class="caret"></div>
      </div>

      <div id="menu" class="menu">
        <div class="menuHead">
          <div style="display:flex; gap:8px; align-items:center;">
            <span class="tag" id="authTag">Signed out</span>
            <span class="tag admin" id="adminTag" style="display:none;">Admin</span>
          </div>
          <button id="closeMenuBtn" class="iconbtn">Close</button>
        </div>

        <div class="menuBody">
          <div class="row">
            <button id="themeBtn">Switch to Light</button>
          </div>

          <!-- SIGNED OUT: ONLY ONE BUTTON ROW -->
          <div id="signedOutPanel">
            <div class="tabs">
              <div id="tabSignIn" class="tab active">Sign In</div>
              <div id="tabSignUp" class="tab">Sign Up</div>
            </div>

            <div class="row">
              <input id="email" type="email" placeholder="Email" />
            </div>
            <div class="row">
              <input id="password" type="password" placeholder="Password" />
            </div>

            <!-- Only ONE row of buttons -->
            <div class="row">
              <button id="primaryAuthBtn">Sign in</button>
              <button id="secondaryAuthBtn">Sign up</button>
            </div>

            <div class="fineprint">
              Tip: Use same email/password on every device to see the same board.
            </div>
          </div>

          <!-- SIGNED IN -->
          <div id="signedInPanel" style="display:none;">
            <div class="fineprint" style="margin-bottom:6px;">
              <div><span class="muted">Email:</span> <span id="profileEmail"></span></div>
              <div><span class="muted">UID:</span> <code id="profileUid"></code></div>
            </div>

            <div class="row">
              <button id="logoutBtn" class="danger">Logout</button>
              <button id="copyUidBtn">Copy UID</button>
            </div>

            <div class="row">
              <button id="adminViewBtn" style="display:none;">Admin: View All</button>
              <button id="myViewBtn" style="display:none;">My Board</button>
            </div>

            <div class="fineprint">
              Board from URL: <code>?board=default</code> or <code>?board=work</code>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="controls">
    <input id="taskInput" type="text" placeholder="New task (e.g., Fix login bug)" />
    <select id="statusSelect">
      <option value="todo">To Do</option>
      <option value="inprogress">In Progress</option>
      <option value="review">Review</option>
      <option value="done">Done</option>
    </select>
    <button id="addBtn">Add</button>
    <button id="clearBtn" class="danger">Clear</button>

    <div class="spacer"></div>

    <button id="exportBtn">Export JSON</button>
    <button id="importBtn">Import JSON</button>
    <input id="importFile" type="file" accept="application/json" style="display:none" />
  </div>

  <div class="statusbar">
    <div>Board: <code id="boardIdLabel"></code></div>
    <div id="syncLabel">Sync: signed out</div>
  </div>

  <div class="wrap">
    <div class="board disabled" id="board">
      <div class="column" data-status="todo">
        <div class="colhead"><div class="colname">To Do <span class="badge" id="count-todo">0</span></div></div>
        <div class="dropzone" id="zone-todo"></div>
      </div>
      <div class="column" data-status="inprogress">
        <div class="colhead"><div class="colname">In Progress <span class="badge" id="count-inprogress">0</span></div></div>
        <div class="dropzone" id="zone-inprogress"></div>
      </div>
      <div class="column" data-status="review">
        <div class="colhead"><div class="colname">Review <span class="badge" id="count-review">0</span></div></div>
        <div class="dropzone" id="zone-review"></div>
      </div>
      <div class="column" data-status="done">
        <div class="colhead"><div class="colname">Done <span class="badge" id="count-done">0</span></div></div>
        <div class="dropzone" id="zone-done"></div>
      </div>
    </div>

    <div id="adminPanel" class="panel"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      doc,
      onSnapshot,
      setDoc,
      getDoc,
      collectionGroup,
      getDocs,
      query
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // Theme
    const THEME_KEY = "kanban_theme";
    function applyTheme(theme){
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem(THEME_KEY, theme);
      updateThemeButton();
    }
    function getTheme(){ return localStorage.getItem(THEME_KEY) || "dark"; }

    // Load config
    async function loadFirebaseConfig() {
      const res = await fetch("./config.json", { cache: "no-store" });
      if (!res.ok) throw new Error("config.json not found. Put it next to index.html");
      return await res.json();
    }

    const firebaseConfig = await loadFirebaseConfig();
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Board ID
    const params = new URLSearchParams(location.search);
    const boardId = (params.get("board") || "default").trim();
    document.getElementById("boardIdLabel").textContent = boardId;

    const $ = (sel) => document.querySelector(sel);

    // UI
    const boardEl = $("#board");
    const adminPanel = $("#adminPanel");

    const syncLabel = $("#syncLabel");
    const setSync = (txt) => (syncLabel.textContent = "Sync: " + txt);

    const profileBtn = $("#profileBtn");
    const menu = $("#menu");
    const closeMenuBtn = $("#closeMenuBtn");
    const avatarEl = $("#avatar");
    const whoName = $("#whoName");
    const whoHint = $("#whoHint");
    const authTag = $("#authTag");
    const adminTag = $("#adminTag");

    const themeBtn = $("#themeBtn");
    function updateThemeButton(){
      const t = document.documentElement.getAttribute("data-theme") || "dark";
      themeBtn.textContent = (t === "dark") ? "Switch to Light" : "Switch to Dark";
    }
    themeBtn.addEventListener("click", () => {
      const t = document.documentElement.getAttribute("data-theme") || "dark";
      applyTheme(t === "dark" ? "light" : "dark");
    });
    applyTheme(getTheme());

    const signedOutPanel = $("#signedOutPanel");
    const signedInPanel = $("#signedInPanel");

    const tabSignIn = $("#tabSignIn");
    const tabSignUp = $("#tabSignUp");

    const emailEl = $("#email");
    const passEl = $("#password");
    const primaryAuthBtn = $("#primaryAuthBtn");
    const secondaryAuthBtn = $("#secondaryAuthBtn");

    const profileEmail = $("#profileEmail");
    const profileUid = $("#profileUid");
    const logoutBtn = $("#logoutBtn");
    const copyUidBtn = $("#copyUidBtn");
    const adminViewBtn = $("#adminViewBtn");
    const myViewBtn = $("#myViewBtn");

    const taskInput = $("#taskInput");
    const statusSelect = $("#statusSelect");
    const addBtn = $("#addBtn");
    const clearBtn = $("#clearBtn");
    const exportBtn = $("#exportBtn");
    const importBtn = $("#importBtn");
    const importFile = $("#importFile");

    const zones = {
      todo: $("#zone-todo"),
      inprogress: $("#zone-inprogress"),
      review: $("#zone-review"),
      done: $("#zone-done"),
    };

    // Menu open/close
    function setMenuOpen(open) { menu.classList.toggle("open", open); }
    profileBtn.addEventListener("click", () => setMenuOpen(!menu.classList.contains("open")));
    closeMenuBtn.addEventListener("click", () => setMenuOpen(false));
    document.addEventListener("click", (e) => {
      if (!e.target.closest(".profileWrap")) setMenuOpen(false);
    });

    // Auth tab state
    let authMode = "in"; // "in" or "up"
    function setAuthTab(which) {
      authMode = which;
      tabSignIn.classList.toggle("active", which === "in");
      tabSignUp.classList.toggle("active", which === "up");

      primaryAuthBtn.textContent = which === "in" ? "Sign in" : "Sign up";
      secondaryAuthBtn.textContent = which === "in" ? "Sign up" : "Sign in";
    }
    tabSignIn.addEventListener("click", () => setAuthTab("in"));
    tabSignUp.addEventListener("click", () => setAuthTab("up"));
    setAuthTab("in");

    // State
    let currentUser = null;
    let unsubscribeBoard = null;
    let isAdmin = false;
    let tasks = [];

    // Helpers
    function uid() {
      return (crypto?.randomUUID?.() ?? ("id-" + Math.random().toString(16).slice(2))) + "-" + Date.now();
    }
    function escapeHtml(s) {
      return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function formatDate(ts) {
      const d = new Date(ts);
      return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "2-digit" });
    }
    function initialsFromEmail(email) {
      const s = (email || "").trim();
      if (!s) return "?";
      const name = s.split("@")[0];
      const parts = name.split(/[._-]+/).filter(Boolean);
      if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
      return (name.slice(0,2) || "?").toUpperCase();
    }

    // Render
    function updateCounts() {
      const counts = { todo: 0, inprogress: 0, review: 0, done: 0 };
      for (const t of tasks) counts[t.status]++;
      $("#count-todo").textContent = counts.todo;
      $("#count-inprogress").textContent = counts.inprogress;
      $("#count-review").textContent = counts.review;
      $("#count-done").textContent = counts.done;
    }
    function clearZones() { Object.values(zones).forEach(z => z.innerHTML = ""); }

    function createCard(task) {
      const card = document.createElement("div");
      card.className = "card";
      card.draggable = true;
      card.dataset.id = task.id;

      card.innerHTML = `
        <p class="cardtitle"></p>
        <div class="meta">
          <span class="pill">${task.status}</span>
          <div class="actions">
            <button class="iconbtn" data-action="edit">Edit</button>
            <button class="iconbtn delete" data-action="delete">Delete</button>
          </div>
        </div>
        <div class="meta" style="margin-top:8px;">
          <span>Created: ${formatDate(task.createdAt)}</span>
          <span class="pill">Drag me</span>
        </div>
      `;
      card.querySelector(".cardtitle").textContent = task.title;

      card.addEventListener("click", async (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;

        if (btn.dataset.action === "delete") {
          tasks = tasks.filter(t => t.id !== task.id);
          await saveCloud();
          render();
        } else if (btn.dataset.action === "edit") {
          const next = prompt("Edit task title:", task.title);
          if (next && next.trim()) {
            const t = tasks.find(t => t.id === task.id);
            if (!t) return;
            t.title = next.trim();
            await saveCloud();
            render();
          }
        }
      });

      card.addEventListener("dragstart", (e) => {
        e.dataTransfer.setData("text/plain", task.id);
        e.dataTransfer.effectAllowed = "move";
        card.style.opacity = "0.6";
      });
      card.addEventListener("dragend", () => { card.style.opacity = "1"; });

      return card;
    }

    function render() {
      clearZones();
      const byCol = { todo: [], inprogress: [], review: [], done: [] };
      for (const t of tasks) byCol[t.status]?.push(t);
      for (const k of Object.keys(byCol)) {
        byCol[k].sort((a,b) => a.createdAt - b.createdAt);
        for (const t of byCol[k]) zones[k].appendChild(createCard(t));
      }
      updateCounts();
    }

    // Firestore
    function boardDocRefForUser(userUid) { return doc(db, "users", userUid, "boards", boardId); }
    function boardDocRef() { return boardDocRefForUser(currentUser.uid); }

    async function ensureBoardDocExists() {
      const ref = boardDocRef();
      const snap = await getDoc(ref);
      if (!snap.exists()) await setDoc(ref, { tasks: [], createdAt: Date.now() });
    }

    async function saveCloud() {
      if (!currentUser) return;
      setSync("saving…");
      await setDoc(boardDocRef(), { tasks, updatedAt: Date.now() }, { merge: true });
      setSync("saved");
    }

    // Add task
    async function addTask() {
      if (!currentUser) return;
      const title = taskInput.value.trim();
      const status = statusSelect.value;
      if (!title) return;
      tasks.push({ id: uid(), title, status, createdAt: Date.now() });
      taskInput.value = "";
      await saveCloud();
      render();
      taskInput.focus();
    }

    addBtn.addEventListener("click", addTask);
    taskInput.addEventListener("keydown", (e) => { if (e.key === "Enter") addTask(); });

    clearBtn.addEventListener("click", async () => {
      if (!currentUser) return;
      if (!confirm("Clear all tasks on this board?")) return;
      tasks = [];
      await saveCloud();
      render();
    });

    // Drag & drop
    document.querySelectorAll(".column").forEach(col => {
      const status = col.dataset.status;
      col.addEventListener("dragover", (e) => {
        if (!currentUser) return;
        e.preventDefault();
        col.classList.add("dragover");
        e.dataTransfer.dropEffect = "move";
      });
      col.addEventListener("dragleave", () => col.classList.remove("dragover"));
      col.addEventListener("drop", async (e) => {
        if (!currentUser) return;
        e.preventDefault();
        col.classList.remove("dragover");
        const id = e.dataTransfer.getData("text/plain");
        const t = tasks.find(x => x.id === id);
        if (!t) return;
        t.status = status;
        await saveCloud();
        render();
      });
    });

    // Import/Export
    exportBtn.addEventListener("click", () => {
      if (!currentUser) return;
      const payload = { boardId, exportedAt: new Date().toISOString(), userUid: currentUser.uid, tasks };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `kanban-${boardId}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    importBtn.addEventListener("click", () => { if (currentUser) importFile.click(); });

    function normalizeImportedTasks(arr) {
      const allowed = new Set(["todo","inprogress","review","done"]);
      const out = [];
      for (const it of arr) {
        if (!it || typeof it !== "object") continue;
        const title = String(it.title ?? "").trim();
        if (!title) continue;
        const status = allowed.has(String(it.status)) ? String(it.status) : "todo";
        const createdAt = Number.isFinite(Number(it.createdAt)) ? Number(it.createdAt) : Date.now();
        out.push({ id: String(it.id ?? uid()), title, status, createdAt });
      }
      out.sort((a,b) => a.createdAt - b.createdAt);
      return out;
    }

    importFile.addEventListener("change", async () => {
      if (!currentUser) return;
      const file = importFile.files?.[0];
      if (!file) return;
      try {
        const parsed = JSON.parse(await file.text());
        const incoming = Array.isArray(parsed) ? parsed : parsed?.tasks;
        if (!Array.isArray(incoming)) throw new Error("Invalid JSON (need array or {tasks:[]}).");
        const normalized = normalizeImportedTasks(incoming);
        if (!confirm(`Import ${normalized.length} tasks? This will REPLACE your board "${boardId}".`)) return;
        tasks = normalized;
        await saveCloud();
        render();
      } catch (e) {
        console.error(e);
        alert(e.message || "Invalid JSON file");
      } finally {
        importFile.value = "";
      }
    });

    // Admin
    async function checkAdmin(uid) {
      try {
        const snap = await getDoc(doc(db, "admins", uid));
        return snap.exists();
      } catch (e) {
        console.error("checkAdmin blocked by rules:", e);
        return false;
      }
    }

    async function loadAllBoardsForAdmin() {
      if (!currentUser || !isAdmin) return;
      setSync("admin loading…");
      adminPanel.classList.add("open");
      adminPanel.innerHTML = `<h2>Admin View</h2><div class="fineprint">Loading all users' boards…</div>`;

      try {
        const q = query(collectionGroup(db, "boards"));
        const snap = await getDocs(q);

        const grouped = new Map();
        snap.forEach(docSnap => {
          const parts = docSnap.ref.path.split("/");
          if (parts.length < 4) return;
          const userId = parts[1];
          const bId = parts[3];
          const data = docSnap.data();
          const t = Array.isArray(data?.tasks) ? data.tasks : [];
          if (!grouped.has(userId)) grouped.set(userId, []);
          grouped.get(userId).push({ boardId: bId, tasks: t });
        });

        let html = `<h2>Admin View (read-only)</h2>
          <div class="fineprint">Users: ${grouped.size} • Board docs: ${snap.size}</div>`;

        for (const [userId, boards] of grouped.entries()) {
          boards.sort((a,b) => a.boardId.localeCompare(b.boardId));
          html += `<div class="userbox">
            <div style="font-weight:650;margin-bottom:6px;">User UID: <code>${escapeHtml(userId)}</code></div>`;
          for (const b of boards) {
            const list = [...b.tasks].sort((x,y) => (x.createdAt||0) - (y.createdAt||0));
            html += `<div class="boardbox">
              <div class="fineprint">Board: <code>${escapeHtml(b.boardId)}</code> • Tasks: ${list.length}</div>
              <ul style="margin:8px 0 0 0;padding-left:18px;">`;
            for (const t of list) {
              html += `<li><span class="pill">${escapeHtml(t.status)}</span> ${escapeHtml(t.title)}</li>`;
            }
            html += `</ul></div>`;
          }
          html += `</div>`;
        }

        adminPanel.innerHTML = html;
        setSync("admin view");
      } catch (e) {
        console.error("Admin read failed:", e);
        adminPanel.innerHTML = `<h2>Admin View</h2><div class="fineprint">Error: ${escapeHtml(e.message || String(e))}</div>`;
        setSync("admin error");
      }
    }

    adminViewBtn.addEventListener("click", async () => {
      if (!isAdmin) return;
      boardEl.style.display = "none";
      await loadAllBoardsForAdmin();
      myViewBtn.style.display = "";
      setMenuOpen(false);
    });

    myViewBtn.addEventListener("click", () => {
      adminPanel.classList.remove("open");
      boardEl.style.display = "";
      myViewBtn.style.display = "none";
      setSync(currentUser ? "live" : "signed out");
      setMenuOpen(false);
    });

    // Auth buttons (single row)
    async function doPrimaryAuth() {
      const email = emailEl.value.trim();
      const pass = passEl.value;
      try {
        if (authMode === "in") {
          setSync("signing in…");
          await signInWithEmailAndPassword(auth, email, pass);
        } else {
          setSync("signing up…");
          await createUserWithEmailAndPassword(auth, email, pass);
        }
        setMenuOpen(false);
      } catch (e) {
        console.error(e);
        setSync("error");
        alert(e.message || "Auth failed");
      }
    }

    async function doSecondaryAuth() {
      // swap mode
      setAuthTab(authMode === "in" ? "up" : "in");
    }

    primaryAuthBtn.addEventListener("click", doPrimaryAuth);
    secondaryAuthBtn.addEventListener("click", doSecondaryAuth);

    // Enter key triggers primary auth when dropdown is open
    passEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") doPrimaryAuth();
    });

    // Logout / copy UID
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      setMenuOpen(false);
    });

    copyUidBtn.addEventListener("click", async () => {
      const u = currentUser?.uid;
      if (!u) return;
      await navigator.clipboard.writeText(u);
      alert("UID copied!");
    });

    // Auth state
    onAuthStateChanged(auth, async (user) => {
      if (unsubscribeBoard) { unsubscribeBoard(); unsubscribeBoard = null; }

      currentUser = user;
      isAdmin = false;

      adminPanel.classList.remove("open");
      boardEl.style.display = "";
      myViewBtn.style.display = "none";
      adminViewBtn.style.display = "none";
      adminTag.style.display = "none";

      if (!user) {
        tasks = [];
        render();
        boardEl.classList.add("disabled");
        setSync("signed out");

        avatarEl.textContent = "?";
        whoName.textContent = "Guest";
        whoHint.textContent = "Sign in";
        authTag.textContent = "Signed out";

        signedOutPanel.style.display = "";
        signedInPanel.style.display = "none";
        setAuthTab("in");
        return;
      }

      boardEl.classList.remove("disabled");
      whoName.textContent = user.email || "Signed in";
      whoHint.textContent = "Profile";
      avatarEl.textContent = initialsFromEmail(user.email);
      authTag.textContent = "Signed in";

      signedOutPanel.style.display = "none";
      signedInPanel.style.display = "";
      profileEmail.textContent = user.email || "";
      profileUid.textContent = user.uid;

      isAdmin = await checkAdmin(user.uid);
      if (isAdmin) {
        adminTag.style.display = "";
        adminViewBtn.style.display = "";
      }

      await ensureBoardDocExists();

      setSync("connecting…");
      unsubscribeBoard = onSnapshot(boardDocRef(), (snap) => {
        const data = snap.data();
        tasks = Array.isArray(data?.tasks) ? data.tasks : [];
        render();
        setSync("live");
      }, (err) => {
        console.error(err);
        setSync("permission error (check rules)");
      });
    });

    render();
  </script>
</body>
</html>
